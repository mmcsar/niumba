============================================
NIUMBA - S√©curisation du R√¥le Admin
============================================

Copiez-collez ce script dans Supabase SQL Editor
et ex√©cutez-le pour masquer le r√¥le admin.

============================================

-- Supprimer la vue si elle existe d√©j√†
DROP VIEW IF EXISTS profiles_public CASCADE;

-- Cr√©er une vue qui masque le r√¥le admin
CREATE VIEW profiles_public AS
SELECT 
  id,
  email,
  full_name,
  phone,
  avatar_url,
  company_name,
  company_logo,
  -- Masquer le r√¥le admin pour les non-admins
  CASE 
    WHEN role = 'admin' AND auth.uid() != id THEN 'user'::user_role
    ELSE role
  END as role,
  language,
  city,
  province,
  is_verified,
  is_active,
  created_at,
  updated_at
FROM profiles;

-- Activer RLS sur la vue
ALTER VIEW profiles_public SET (security_invoker = true);

-- Supprimer l'ancienne policy trop permissive
DROP POLICY IF EXISTS "profiles_select_public" ON profiles;

-- Cr√©er une nouvelle policy qui masque le r√¥le admin
CREATE POLICY "profiles_select_secure" ON profiles 
FOR SELECT USING (
  -- Les utilisateurs peuvent voir leur propre profil complet
  auth.uid() = id
  OR
  -- Les admins peuvent voir tous les profils
  EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin')
  OR
  -- Les autres peuvent voir les profils publics (sans r√¥le admin expos√©)
  (
    role != 'admin'
    AND (
      is_active = true
      OR auth.uid() IS NOT NULL
    )
  )
);

-- Fonction pour obtenir le r√¥le visible (masque admin pour les non-admins)
CREATE OR REPLACE FUNCTION get_visible_role(profile_id UUID, user_role user_role)
RETURNS user_role AS $$
BEGIN
  -- Si l'utilisateur demande son propre profil, retourner le r√¥le r√©el
  IF auth.uid() = profile_id THEN
    RETURN user_role;
  END IF;
  
  -- Si l'utilisateur est admin, retourner le r√¥le r√©el
  IF EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin') THEN
    RETURN user_role;
  END IF;
  
  -- Sinon, masquer le r√¥le admin
  IF user_role = 'admin' THEN
    RETURN 'user'::user_role;
  END IF;
  
  RETURN user_role;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Vue alternative qui utilise la fonction
CREATE OR REPLACE VIEW profiles_public_secure AS
SELECT 
  id,
  email,
  full_name,
  phone,
  avatar_url,
  company_name,
  company_logo,
  get_visible_role(id, role) as role,
  language,
  city,
  province,
  is_verified,
  is_active,
  created_at,
  updated_at
FROM profiles;

-- Activer RLS sur la vue
ALTER VIEW profiles_public_secure SET (security_invoker = true);

-- Message de confirmation
DO $$
BEGIN
  RAISE NOTICE '‚úÖ S√©curisation du r√¥le admin termin√©e !';
  RAISE NOTICE '‚úÖ Vue profiles_public cr√©√©e';
  RAISE NOTICE '‚úÖ Vue profiles_public_secure cr√©√©e';
  RAISE NOTICE '‚úÖ Policy RLS s√©curis√©e cr√©√©e';
  RAISE NOTICE '‚úÖ Fonction get_visible_role cr√©√©e';
  RAISE NOTICE '';
  RAISE NOTICE 'üîí Le r√¥le admin est maintenant masqu√© pour les utilisateurs normaux !';
END $$;


